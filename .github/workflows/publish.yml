name: Publish

# Run every Sunday @ 03:00 UTC
on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0"

jobs:
  publish:
    # Needed to make puppeteer work on GitHub Actions
    # See https://github.com/puppeteer/puppeteer/issues/12818
    # runs-on: ubuntu-latest
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout workflow ‚¨áÔ∏è
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3
        with:
          repository: "gauntface/workflows-static-site"
          path: "workflows-static-site"

      - name: Checkout site ‚¨áÔ∏è
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # v3
        with:
          submodules: true
          path: "site"

      - name: Install action NPM Deps üåé
        run: |
          cd ./workflows-static-site/
          npm install

      - name: Install site NPM Deps üåé
        run: |
          cd ./site/
          npm install

      - name: Configure AWS Credentials ‚òÅÔ∏è
        uses: aws-actions/configure-aws-credentials@v1-node16
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-1

      - name: Build üîß
        env:
          VITE_FIREBASE_AUTH_DOMAIN: "focus-gaunt-dev-98424.firebaseapp.com"
          VITE_FIREBASE_API_KEY: "AIzaSyCNng5kcG181MrVJ0TW36TdNnRetgwnQWM"
          VITE_FIREBASE_APP_ID: "1:691636080749:web:666f1a18a3a354038b2f64"
          VITE_FIREBASE_PROJECT_ID: "focus-gaunt-dev-98424"
          VITE_API_SERVER: "https://focus-api.gaunt.dev"
        run: |
          cd ./site/
          npm run build

      - name: Project Tests üß™
        run: |
          cd ./site/
          npm run test --if-present

      - name: Deploy to AWS üå§Ô∏è
        run: npx --package @gauntface/cli gauntface aws s3 deploy-static-site --directory="./site/dist/" --bucket_name="focus.gaunt.dev" --delete_exclude="generated/*"
        shell: bash
